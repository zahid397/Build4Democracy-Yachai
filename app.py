import streamlit as st
import json
import pandas as pd
import requests
import google.generativeai as genai
import os
import re # (A) JSON ржкрж╛рж░рзНрж╕рж┐ржВ ржПрж░ ржЬржирзНржп ржЗржорзНржкрзЛрж░рзНржЯ
import logging # (E) рж▓ржЧрж┐ржВ ржПрж░ ржЬржирзНржп ржЗржорзНржкрзЛрж░рзНржЯ
from datetime import datetime

# --- 1. ржкрзЗржЬ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржПржмржВ рж▓ржЧрж┐ржВ рж╕рзЗржЯржЖржк ---
st.set_page_config(
    page_title="ржпрж╛ржЪрж╛ржЗ | рж╕рзБрж░ржХрзНрж╖рж┐ржд ржЧржгрждржирзНрждрзНрж░",
    page_icon="ЁЯза",
    layout="wide",
    initial_sidebar_state="expanded"
)

# (E) рж▓ржЧрж┐ржВ ржХржиржлрж┐ржЧрж╛рж░ ржХрж░рж╛
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    filename='yachai_app.log', # рж▓ржЧржЧрзБрж▓рзЛ ржПржХржЯрж┐ ржлрж╛ржЗрж▓рзЗ рж╕рзЗржн рж╣ржмрзЗ
    filemode='a'
)
logging.info("ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи рж╢рзБрж░рзБ рж╣рзЯрзЗржЫрзЗред")

# --- 2. рж╕рж┐ржХрзНрж░рзЗржЯ ржПржмржВ API ржХрзА рж▓рзЛржб ---
GEMINI_API_KEY = st.secrets.get("GEMINI_API_KEY", "YOUR_GEMINI_KEY")
BOT_TOKEN = st.secrets.get("bot_token", "YOUR_BOT_TOKEN")
CHAT_ID = st.secrets.get("chat_id", "YOUR_CHAT_ID")
ADMIN_PASS = st.secrets.get("ADMIN_PASS", "demo123")
MAX_INPUT_LENGTH = 3000 # (D) ржЗржиржкрзБржЯ рж▓рж┐ржорж┐ржЯ

# --- 3. (A) ржирж┐рж░рж╛ржкржж JSON ржкрж╛рж░рзНрж╕рж┐ржВ ржлрж╛ржВрж╢ржи ---
def safe_parse_json(text):
    """
    AI-ржПрж░ ржЬрзЗржирж╛рж░рзЗржЯ ржХрж░рж╛ ржЯрзЗржХрзНрж╕ржЯ ржерзЗржХрзЗ ржирж┐рж░рж╛ржкржжрзЗ JSON ржЕржмржЬрзЗржХрзНржЯ ржмрзЗрж░ ржХрж░рзЗ ржЖржирзЗред
    """
    try:
        # ```json...``` ржЯрзНржпрж╛ржЧржЧрзБрж▓рзЛ рж░рж┐ржорзБржн ржХрж░рж╛
        t = text.strip()
        t = re.sub(r"^```json", "", t, flags=re.I).strip()
        t = re.sub(r"```$", "", t).strip()
        
        # ржЯрзЗржХрзНрж╕ржЯрзЗрж░ ржнрзЗрждрж░ ржерзЗржХрзЗ { ... } ржЕржВрж╢ржЯрж┐ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж╛
        m = re.search(r"(\{.*\})", t, flags=re.S)
        if m:
            t = m.group(1)
        
        return json.loads(t)
    except Exception as e:
        logging.error(f"JSON ржкрж╛рж░рзНрж╕рж┐ржВ ржмрзНржпрж░рзНрже рж╣рзЯрзЗржЫрзЗред ржЯрзЗржХрзНрж╕ржЯ: {text}, рждрзНрж░рзБржЯрж┐: {e}")
        return None # ржкрж╛рж░рзНрж╕рж┐ржВ ржмрзНржпрж░рзНрже рж╣рж▓рзЗ None рж░рж┐ржЯрж╛рж░рзНржи ржХрж░ржмрзЗ

# --- 4. ржЬрзЗржорж┐ржирж┐ AI ржлрж╛ржВрж╢ржи (ржЙржирзНржиржд ржлрж▓ржмрзНржпрж╛ржХ рж╕рж┐рж╕рзНржЯрзЗржо рж╕рж╣) ---
def get_gemini_analysis(text_to_analyze):
    try:
        if GEMINI_API_KEY == "YOUR_GEMINI_KEY" or not GEMINI_API_KEY.startswith("AIza"):
            st.error("Gemini API ржХрзА рж╕рзЗржЯ ржХрж░рж╛ ржирзЗржЗред `secrets.toml` ржлрж╛ржЗрж▓ ржЪрзЗржХ ржХрж░рзБржиред")
            logging.error("GEMINI_API_KEY ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред")
            return None
        genai.configure(api_key=GEMINI_API_KEY)
    except Exception as e:
        st.error(f"API ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржирзЗ рж╕ржорж╕рзНржпрж╛: {e}")
        logging.error(f"Gemini API ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи рждрзНрж░рзБржЯрж┐: {e}")
        return None

    # ============== ржЖржкржирж╛рж░ ржлрж▓ржмрзНржпрж╛ржХ рж╕рж┐рж╕рзНржЯрзЗржо ржПржЦрж╛ржирзЗ ==============
    models_to_try = [
        'gemini-2.5-flash',         # ржЖржкржирж╛рж░ ржЕржирзБрж░рзЛржз ржХрж░рж╛ ржкрзНрж░рж╛ржЗржорж╛рж░рж┐ ржоржбрзЗрж▓
        'gemini-1.5-flash-latest'   # ржлрж▓ржмрзНржпрж╛ржХ ржоржбрзЗрж▓
    ]
    # =======================================================
    
    prompt = f"""
    рждрзБржорж┐ 'ржпрж╛ржЪрж╛ржЗ' ржирж╛ржорзЗрж░ ржПржХржЬржи AI ржлрзНржпрж╛ржХрзНржЯ-ржЪрзЗржХрж╛рж░ред рждрзЛржорж╛рж░ ржХрж╛ржЬ ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рзЗрж░ ржирж┐рж░рзНржмрж╛ржЪржи рж╕ржорзНржкрж░рзНржХрж┐ржд ржнрзБрж▓ рждржерзНржп рж╢ржирж╛ржХрзНржд ржХрж░рж╛ред
    ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржЯрзЗржХрзНрж╕ржЯржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзЛ: "{text_to_analyze}"
    рждрзЛржорж╛рж░ ржЙрждрзНрждрж░ ржЕржмрж╢рзНржпржЗ ржПржХржЯрж┐ JSON ржлрж░ржорзНржпрж╛ржЯрзЗ рж╣рждрзЗ рж╣ржмрзЗред ржЕржирзНржп ржХрзЛржирзЛ ржЯрзЗржХрзНрж╕ржЯ ржерж╛ржХрж╛ ржЪрж▓ржмрзЗ ржирж╛ред
    ржлрж░ржорзНржпрж╛ржЯ:
    {{
      "score": [рзж-рззрзжрзж ржкрж░рзНржпржирзНржд ржПржХржЯрж┐ рж╕ржВржЦрзНржпрж╛, ржпрзЗржЦрж╛ржирзЗ рззрзжрзж ржорж╛ржирзЗ ржПржЯрж┐ рж╕ржорзНржкрзВрж░рзНржг ржорж┐ржерзНржпрж╛],
      "verdict": ["рж╕рждрзНржп", "рж╕ржорзНржнржмржд рж╕рждрзНржп", "ржмрж┐ржнрзНрж░рж╛ржирзНрждрж┐ржХрж░", "рж╕ржорзНржнржмржд ржорж┐ржерзНржпрж╛", "ржорж┐ржерзНржпрж╛"],
      "justification": "[ржХрзЗржи ржПржЯрж┐ рж╕рждрзНржп ржмрж╛ ржорж┐ржерзНржпрж╛, рждрж╛рж░ ржПржХржЯрж┐ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржмрзНржпрж╛ржЦрзНржпрж╛ ржмрж╛ржВрж▓рж╛рждрзЗ]"
    }}
    """
    
    response_text = None # рж░рзЗрж╕ржкржирзНрж╕ ржЬржорж╛ рж░рж╛ржЦрж╛рж░ ржЬрж╛рзЯржЧрж╛

    # ржПржХржЯрж┐ рж▓рзБржкрзЗрж░ ржорж╛ржзрзНржпржорзЗ ржоржбрзЗрж▓ржЧрзБрж▓рзЛ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛
    for model_name in models_to_try:
        try:
            logging.info(f"{model_name} ржоржбрзЗрж▓ ржжрж┐рзЯрзЗ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
            model = genai.GenerativeModel(model_name)
            response = model.generate_content(prompt)
            response_text = response.text
            
            # рж╕ржлрж▓ рж╣рж▓рзЗ, рж▓рзБржк ржмрзНрж░рзЗржХ ржХрж░ржмрзЗ
            logging.info(f"{model_name} ржоржбрзЗрж▓ рж╕ржлрж▓ рж╣рзЯрзЗржЫрзЗред")
            break 
        
        except Exception as e:
            # ржоржбрзЗрж▓ржЯрж┐ ржмрзНржпрж░рзНрже рж╣рж▓рзЗ рж▓ржЧ ржХрж░рж╛ ржПржмржВ ржкрж░ржмрж░рзНрждрзА ржоржбрзЗрж▓рзЗ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛
            logging.warning(f"'{model_name}' ржоржбрзЗрж▓рзЗ рждрзНрж░рзБржЯрж┐: {e}. ржкрж░ржмрж░рзНрждрзА ржоржбрзЗрж▓рзЗ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
            continue # ржкрж░ржмрж░рзНрждрзА ржоржбрзЗрж▓рзЗ ржпрж╛ржУ

    # ржпржжрж┐ рж╕ржм ржоржбрзЗрж▓ ржмрзНржпрж░рзНрже рж╣рзЯ
    if response_text is None:
        logging.error("рж╕ржХрж▓ AI ржоржбрзЗрж▓ ржХрж▓ ржмрзНржпрж░рзНрже рж╣рзЯрзЗржЫрзЗред")
        st.error("AI рж╕рзЗржмрж╛ржЯрж┐ ржПржЗ ржорзБрж╣рзВрж░рзНрждрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛ржЪрзНржЫрзЗ ржирж╛ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржХрж┐ржЫрзБржХрзНрж╖ржг ржкрж░ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред")
        return None

    # рж╕ржлрж▓ рж╣рж▓рзЗ рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛рж░рзНрж╕ ржХрж░рж╛
    try:
        analysis = safe_parse_json(response_text)
        
        if analysis is None:
            logging.error(f"AI ржПржХржЯрж┐ ржнрзБрж▓ ржлрж░ржорзНржпрж╛ржЯрзЗ ржЙрждрзНрждрж░ ржжрж┐рзЯрзЗржЫрзЗ: {response_text}")
            st.error("AI ржПрж░ ржХрж╛ржЫ ржерзЗржХрзЗ ржЙрждрзНрждрж░ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред")
            return None
        
        # (C) рж╕рзНржХрзЛрж░ ржирж░рзНржорж╛рж▓рж╛ржЗржЬрзЗрж╢ржи
        raw_score = analysis.get('score')
        score = 0
        try:
            numeric_score = float(raw_score)
            if numeric_score <= 1.0 and numeric_score > 0: # 0-1 рж╕рзНржХрзЗрж▓ ржЪрзЗржХ
                score = int(numeric_score * 100)
            elif numeric_score >= 1.0: # 0-100 рж╕рзНржХрзЗрж▓
                score = int(numeric_score)
        except (ValueError, TypeError, TypeError):
            logging.warning(f"AI ржПржХржЯрж┐ ржнрзБрж▓ рж╕рзНржХрзЛрж░ ржлрж░ржорзНржпрж╛ржЯ ржжрж┐рзЯрзЗржЫрзЗ: {raw_score}")
            score = 0
            
        analysis['score'] = score
        return analysis

    except Exception as e:
        logging.exception(f"рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛рж░рзНрж╕рж┐ржВ-ржП ржЕржЬрж╛ржирж╛ рждрзНрж░рзБржЯрж┐: {e}")
        st.error("AI ржПрж░ ржЙрждрзНрждрж░ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗред")
        return None


# --- 5. ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржлрж╛ржВрж╢ржи (ржЙржирзНржиржд) ---
def send_alert(message):
    if BOT_TOKEN == "YOUR_BOT_TOKEN" or CHAT_ID == "YOUR_CHAT_ID":
        st.warning("тЪая╕П ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо ржЯрзЛржХрзЗржи/ржЪрзНржпрж╛ржЯ ID рж╕рзЗржЯ ржХрж░рж╛ ржирзЗржЗред ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛ржирзЛ рж╕ржорзНржнржм ржирзЯред")
        logging.warning("ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо ржЯрзЛржХрзЗржи ржмрж╛ ржЪрзНржпрж╛ржЯ ржЖржЗржбрж┐ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред")
        return False
    try:
        url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        payload = {"chat_id": CHAT_ID, "text": message, "parse_mode": "HTML"}
        response = requests.post(url, data=payload, timeout=10) # ржЯрж╛ржЗржоржЖржЙржЯ ржпрзЛржЧ ржХрж░рж╛
        
        if response.status_code == 200:
            # st.success("ЁЯУ▒ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ!") # ржПржЗ рж▓рж╛ржЗржиржЯрж┐ ржорзНржпрж╛ржирзБрзЯрж╛рж▓ ржмрж╛ржЯржирзЗ ржжрзЗржЦрж╛ржирзЛ рж╣ржмрзЗ
            logging.info("ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред")
            return True
        else:
            st.error(f"тЭМ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛рждрзЗ рж╕ржорж╕рзНржпрж╛: {response.text}")
            logging.error(f"ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо API рждрзНрж░рзБржЯрж┐: {response.status_code} - {response.text}")
            return False
    except requests.exceptions.RequestException as e: # ржирзЗржЯржУрзЯрж╛рж░рзНржХ ржПрж░рж░ ржзрж░рж╛
        st.error(f"тЭМ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржПрж░рж░: {str(e)}")
        logging.exception(f"ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо ржкрж╛ржарж╛рждрзЗ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ рждрзНрж░рзБржЯрж┐: {e}")
        return False

# --- 6. ржбрзЗржЯрж╛ рж▓рзЛржб/рж╕рзЗржн ржлрж╛ржВрж╢ржи (ржЙржирзНржиржд рж▓ржЧрж┐ржВ) ---
DATA_FILE = "submissions.json"

@st.cache_data(ttl=30)
def load_data():
    try:
        data = [json.loads(line) for line in open(DATA_FILE, "r", encoding="utf-8")]
        df = pd.DataFrame(data)
        if "final_verdict" not in df.columns:
            df["final_verdict"] = None
        if "timestamp" not in df.columns:
            df["timestamp"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        cols_order = ["timestamp", "text", "score", "verdict", "justification", "final_verdict"]
        existing_cols = [col for col in cols_order if col in df.columns]
        df = df[existing_cols]
        return df.sort_values(by="timestamp", ascending=False)
    except FileNotFoundError:
        logging.warning(f"тЭМ {DATA_FILE} ржлрж╛ржЗрж▓ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред ржПржХржЯрж┐ рж╕рзНржпрж╛ржорзНржкрж▓ ржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
        sample_data = [
            {"text": "ржнрзЛржЯрж╛рж░ рж▓рж┐рж╕рзНржЯрзЗ рзз ржХрзЛржЯрж┐ ржирж╛ржо ржЕржжрзГрж╢рзНржп рж╣рзЯрзЗржЫрзЗ!", "score": 80, "verdict": "рж╕ржорзНржнржмржд ржорж┐ржерзНржпрж╛", "justification": "ржПржЯрж┐ ржПржХржЯрж┐ ржкрзБрж░рж╛ржирзЛ ржЧрзБржЬржмред", "timestamp": "2025-11-01 10:30:00", "final_verdict": None},
        ]
        df = pd.DataFrame(sample_data)
        save_data(df) # рж╕рзЗржн ржлрж╛ржВрж╢ржи ржХрж▓ ржХрж░рж╛
        return df
    except Exception as e:
        st.error(f"ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛: {e}")
        logging.exception(f"ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рждрзЗ ржмрзНржпрж░рзНрже: {e}")
        return pd.DataFrame()

def save_data(df):
    try:
        df.to_json(DATA_FILE, orient="records", lines=True, force_ascii=False)
        logging.info(f"{DATA_FILE} ржлрж╛ржЗрж▓рзЗ ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
    except Exception as e:
        st.error(f"ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛: {e}")
        logging.exception(f"ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рждрзЗ ржмрзНржпрж░рзНрже: {e}")

# --- 7. рж╕рж╛ржЗржбржмрж╛рж░ ржирзЗржнрж┐ржЧрзЗрж╢ржи ---
st.sidebar.title("ЁЯза ржпрж╛ржЪрж╛ржЗ (Yachai)")
st.sidebar.subheader("ржпрж╛ржЪрж╛ржЗ рждржерзНржпрзЗ, рж╕рзБрж░ржХрзНрж╖рж┐ржд ржЧржгрждржирзНрждрзНрж░ред")
page = st.sidebar.radio("ржирзЗржнрж┐ржЧрзЗрж╢ржи", ["ЁЯФН ржирж╛ржЧрж░рж┐ржХ ржкрзЛрж░рзНржЯрж╛рж▓", "ЁЯзСтАНЁЯТ╝ ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓"])
st.sidebar.markdown("---")

# --- 8. ржкрзЗржЗржЬ рзз: ржирж╛ржЧрж░рж┐ржХ ржкрзЛрж░рзНржЯрж╛рж▓ (ржЙржирзНржиржд) ---
if page == "ЁЯФН ржирж╛ржЧрж░рж┐ржХ ржкрзЛрж░рзНржЯрж╛рж▓":
    st.title("рждржерзНржп ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржи")
    st.caption("AI-ржЪрж╛рж▓рж┐ржд ржлрзНржпрж╛ржХрзНржЯ-ржЪрзЗржХрж┐ржВ ржкрзНрж▓рзНржпрж╛ржЯржлрж░рзНржо")

    # (F) PII рж╕рзБрж░ржХрзНрж╖рж╛ рж╕рждрж░рзНржХрждрж╛
    st.warning("тЪая╕П **рж╕рждрж░рзНржХрждрж╛:** ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржХрзЛржирзЛ ржмрзНржпржХрзНрждрж┐ржЧржд рждржерзНржп (ржпрзЗржоржи: ржлрзЛржи ржиржорзНржмрж░, NID, ржарж┐ржХрж╛ржирж╛) ржПржЦрж╛ржирзЗ ржЬржорж╛ ржжрзЗржмрзЗржи ржирж╛ред")

    st.write("ЁЯСЙ ржирж┐ржЪрзЗ рж╕ржирзНржжрзЗрж╣ржЬржиржХ рждржерзНржп, ржЦржмрж░ ржмрж╛ рж╕рзЛрж╢рзНржпрж╛рж▓ ржорж┐ржбрж┐рзЯрж╛ ржкрзЛрж╕рзНржЯ ржкрзЗрж╕рзНржЯ ржХрж░рзБржи:")
    user_input = st.text_area(
        "ржЖржкржирж╛рж░ рждржерзНржп рж▓рж┐ржЦрзБржи:", 
        placeholder="ржЙржжрж╛рж╣рж░ржг: 'ржирж┐рж░рзНржмрж╛ржЪржирзЗрж░ рждрж╛рж░рж┐ржЦ ржЖржмрж╛рж░рзЛ ржкрзЗржЫрж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ...' ржмрж╛ ржХрзЛржирзЛ ржлрзЗрж╕ржмрзБржХ ржкрзЛрж╕рзНржЯ...", 
        height=150,
        label_visibility="collapsed"
    )

    if st.button("ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржи", type="primary"):
        input_text = user_input.strip()
        
        # (D) ржЗржиржкрзБржЯ ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи
        if input_text == "":
            st.warning("ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛рж░ ржЬржирзНржп ржХрж┐ржЫрзБ рж▓рж┐ржЦрзБржи!")
        elif len(input_text) > MAX_INPUT_LENGTH:
            st.error(f"тЭМ ржЗржиржкрзБржЯржЯрж┐ ржЦрзБржм ржжрзАрж░рзНржШред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ {MAX_INPUT_LENGTH} ржЕржХрзНрж╖рж░рзЗрж░ ржоржзрзНржпрзЗ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржХрж░рзБржиред")
            logging.warning(f"ржЗржиржкрзБржЯ ржжрзИрж░рзНржШрзНржп ({len(input_text)}) ржЕрждрж┐ржХрзНрж░ржо ржХрж░рзЗржЫрзЗред")
        else:
            with st.spinner("AI ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░ржЫрзЗ... ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи..."):
                analysis_result = get_gemini_analysis(input_text)

                if analysis_result:
                    st.subheader("AI ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржлрж▓рж╛ржлрж▓:")
                    score = analysis_result.get('score', 0)
                    verdict = analysis_result.get('verdict', 'N/A')
                    justification = analysis_result.get('justification', 'N/A')

                    if score > 75:
                        st.error(f"**ржнрж╛рж░рзНржбрж┐ржХрзНржЯ: {verdict}** (ржорж┐ржерзНржпрж╛ рж╣ржУрзЯрж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛: {score}%)")
                    elif score > 50:
                        st.warning(f"**ржнрж╛рж░рзНржбрж┐ржХрзНржЯ: {verdict}** (ржорж┐ржерзНржпрж╛ рж╣ржУрзЯрж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛: {score}%)")
                    else:
                        st.success(f"**ржнрж╛рж░рзНржбрж┐ржХрзНржЯ: {verdict}** (ржорж┐ржерзНржпрж╛ рж╣ржУрзЯрж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛: {score}%)")

                    st.info(f"**ржмрзНржпрж╛ржЦрзНржпрж╛:** {justification}")
                    
                    data_to_save = {
                        "text": input_text,
                        "score": score,
                        "verdict": verdict,
                        "justification": justification,
                        "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "final_verdict": None # === ржмрж╛ржЧ ржлрж┐ржХрзНрж╕ (ржнрж╛рж░рзНрж╕ржи рзй.рзк) ===
                    }
                    
                    try:
                        with open(DATA_FILE, "a", encoding="utf-8") as f:
                            json.dump(data_to_save, f, ensure_ascii=False)
                            f.write("\n")
                        # (E) рж╕ржлрж▓ рж╕рзЗржнрзЗ рж▓ржЧрж┐ржВ
                        logging.info(f"ржирждрзБржи рждржерзНржп ржЬржорж╛ рж╣рзЯрзЗржЫрзЗ: {input_text[:50]}...")
                        st.success("тЬЕ ржЖржкржирж╛рж░ рждржерзНржпржЯрж┐ ржЖржорж╛ржжрзЗрж░ ржбрзЗржЯрж╛ржмрзЗрж╕рзЗ рж╕ржВрж░ржХрзНрж╖рж┐ржд рж╣рзЯрзЗржЫрзЗред ржлрзНржпрж╛ржХрзНржЯ-ржЪрзЗржХрж╛рж░рж░рж╛ ржПржЯрж┐ рж░рж┐ржнрж┐ржЙ ржХрж░ржмрзЗржиред")
                    except Exception as e:
                        st.error(f"ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {e}")
                        logging.exception(f"ржирждрзБржи рждржерзНржп {DATA_FILE}-ржП рж╕рзЗржн ржХрж░рждрзЗ ржмрзНржпрж░рзНржеред")

# --- 9. ржкрзЗржЗржЬ рзи: ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓ (ржЙржирзНржиржд) ---
elif page == "ЁЯзСтАНЁЯТ╝ ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓":
    st.title("ЁЯзСтАНЁЯТ╝ ржпрж╛ржЪрж╛ржЗ ржлрзНржпрж╛ржХрзНржЯ-ржЪрзЗржХрж╛рж░ ржкрзНржпрж╛ржирзЗрж▓")
    st.caption("ржЪрзВржбрж╝рж╛ржирзНржд ржпрж╛ржЪрж╛ржЗ ржПржмржВ ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ рж╕рж┐рж╕рзНржЯрзЗржо")

    password = st.sidebar.text_input("ржЕрзНржпрж╛ржбржорж┐ржи ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рж▓рж┐ржЦрзБржи:", type="password")
    
    if password == ADMIN_PASS:
        st.sidebar.success("рж▓ржЧ-ржЗржи рж╕ржлрж▓!")
        logging.info("ржЕрзНржпрж╛ржбржорж┐ржи рж▓ржЧржЗржи рж╕ржлрж▓ред")

        # ==========================================================
        # ============== ржЖржкржирж╛рж░ ржпрзЛржЧ ржХрж░рж╛ ржХржирзНржЯрзНрж░рзЛрж▓ (ржнрж╛рж░рзНрж╕ржи рзй.рзз) ==============
        st.sidebar.markdown("### ЁЯФФ Alert settings")
        alert_threshold = st.sidebar.slider(
            "Alert threshold (score %) тАФ ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржпрж╛ржмрзЗ ржпржжрж┐ рж╕рзНржХрзЛрж░ тЙе ржПржЗ ржорж╛ржи", 
            min_value=0, max_value=100, value=75, step=5
        )
        auto_send = st.sidebar.checkbox("Auto-send alerts when tagged 'ржорж┐ржерзНржпрж╛' and score тЙе threshold", value=False)

        st.sidebar.markdown("---")
        # Quick test alert
        if st.sidebar.button("ЁЯУ▓ Send test alert"):
            test_msg = "ЁЯФФ [TEST] YachaiBot test alert тАФ ржПржЯрж╛ ржПржХржЯрж┐ ржЯрзЗрж╕рзНржЯ ржорзЗрж╕рзЗржЬред"
            ok = send_alert(test_msg)
            if ok:
                st.sidebar.success("Test alert ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ тАФ рждрзЛрж░ ржлрзЛржирзЗ ржЪрзЗржХ ржХрж░ред")
            else:
                st.sidebar.error("Test alert ржкрж╛ржарж╛рждрзЗ ржмрзНржпрж░рзНржеред рж▓ржЧ ржЪрзЗржХ ржХрж░ред")
        
        # ==========================================================
        # ============== ржЖржкржирж╛рж░ ржпрзЛржЧ ржХрж░рж╛ ржирждрзБржи ржбрж┐ржмрж╛ржЧ ржкрзНржпрж╛ржирзЗрж▓ (ржнрж╛рж░рзНрж╕ржи рзй.рзй) ==============
        st.sidebar.markdown("---") # рж╕рзЗржкрж╛рж░рзЗржЯрж░
        with st.sidebar.expander("ЁЯзй Secrets Debug Panel", expanded=False):
            st.write("**GEMINI_API_KEY:**", "тЬЕ рж▓рзЛржб рж╣ржпрж╝рзЗржЫрзЗ" if GEMINI_API_KEY and "AIza" in GEMINI_API_KEY else "тЭМ ржирзЗржЗ")
            st.write("**BOT_TOKEN:**", "тЬЕ рж▓рзЛржб рж╣ржпрж╝рзЗржЫрзЗ" if BOT_TOKEN and ":" in BOT_TOKEN else "тЭМ ржирзЗржЗ")
            # ржЪрзНржпрж╛ржЯ ржЖржЗржбрж┐ ржЪрзЗржХ (ржирзЗржЧрзЗржЯрж┐ржн рж╕ржВржЦрзНржпрж╛ рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рж╛рж░ ржЬржирзНржп)
            chat_id_check = CHAT_ID and (CHAT_ID.isdigit() or (CHAT_ID.startswith("-") and CHAT_ID[1:].isdigit()))
            st.write("**CHAT_ID:**", f"тЬЕ {CHAT_ID}" if chat_id_check else "тЭМ ржирзЗржЗ")
            st.write("**ADMIN_PASS:**", "тЬЕ рж╕рзЗржЯ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ" if ADMIN_PASS and ADMIN_PASS != "demo123" else "тЭМ (ржбрж┐ржлрж▓рзНржЯ/ржирзЗржЗ)")
            
            if st.sidebar.button("ЁЯУ▓ Test Telegram Alert (Debug)", key="debug_test_alert"):
                test_msg = "ЁЯзк Debug: YachaiBot test alert тАФ рж╕рж┐ржХрзНрж░рзЗржЯ ржпрж╛ржЪрж╛ржЗ рж╕ржлрж▓!"
                ok = send_alert(test_msg)
                if ok:
                    st.success("тЬЕ ржЯрзЗрж╕рзНржЯ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ!")
                else:
                    st.error("тЭМ ржЯрзЗрж╕рзНржЯ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛ржирзЛ ржпрж╛ржпрж╝ржирж┐ред")
        # ==========================================================


        df = load_data()

        # рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб
        st.sidebar.header("ЁЯУК рж╕рзНржЯрзНржпрж╛ржЯрж┐рж╕рзНржЯрж┐ржХрзНрж╕")
        total_reports = len(df)
        verified_reports = df["final_verdict"].notna().sum()
        pending_reports = total_reports - verified_reports
        false_reports = (df["final_verdict"] == "ржорж┐ржерзНржпрж╛").sum()

        st.sidebar.metric("ржорзЛржЯ рж░рж┐ржкрзЛрж░рзНржЯ", total_reports)
        st.sidebar.metric("ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ", verified_reports)
        st.sidebar.metric("ржпрж╛ржЪрж╛ржЗ ржмрж╛ржХрж┐ ржЖржЫрзЗ", pending_reports)
        st.sidebar.metric("тЭМ ржорж┐ржерзНржпрж╛ рж╢ржирж╛ржХрзНржд рж╣рзЯрзЗржЫрзЗ", false_reports)
        
        st.sidebar.markdown("---") # рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржПржмржВ рж░рж┐рж▓рзЛржб ржмрж╛ржЯржирзЗрж░ ржорж╛ржЭрзЗрж░ рж╕рзЗржкрж╛рж░рзЗржЯрж░
        if st.sidebar.button("ЁЯФД ржбрзЗржЯрж╛ рж░рж┐рж▓рзЛржб ржХрж░рзБржи"):
            st.cache_data.clear()
            logging.info("ржЕрзНржпрж╛ржбржорж┐ржи ржбрзЗржЯрж╛ рж░рж┐рж▓рзЛржб ржХрж░рзЗржЫрзЗржиред")
            st.rerun()

        st.info(f"ржорзЛржЯ {pending_reports} ржЯрж┐ рж░рж┐ржкрзЛрж░рзНржЯ ржпрж╛ржЪрж╛ржЗрзЯрзЗрж░ ржЬржирзНржп ржкрзЗржирзНржбрж┐ржВ ржЖржЫрзЗред")
        
        filter_option = st.radio(
            "ржлрж┐рж▓рзНржЯрж╛рж░ ржХрж░рзБржи:",
            ["ржкрзЗржирзНржбрж┐ржВ", "ржпрж╛ржЪрж╛ржЗржХрзГржд", "рж╕ржм рж░рж┐ржкрзЛрж░рзНржЯ"],
            horizontal=True
        )
        
        if filter_option == "ржкрзЗржирзНржбрж┐ржВ":
            df_display = df[df["final_verdict"].isna()]
        elif filter_option == "ржпрж╛ржЪрж╛ржЗржХрзГржд":
            df_display = df[df["final_verdict"].notna()]
        else:
            df_display = df

        if df_display.empty:
            st.warning("ржПржЗ ржлрж┐рж▓рзНржЯрж╛рж░рзЗ ржХрзЛржирзЛ ржбрзЗржЯрж╛ ржирзЗржЗред")
        else:
            st.dataframe(df_display, use_container_width=True, height=300)

            st.subheader("тЬЕ ржПржХржЯрж┐ рж░рж┐ржкрзЛрж░рзНржЯ ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржи:")
            
            # рж╢рзБржзрзБржорж╛рждрзНрж░ ржкрзЗржирзНржбрж┐ржВ ржЖржЗржЯрзЗржоржЧрзБрж▓рзЛ ржерзЗржХрзЗ рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рж╛рж░ ржЕржкрж╢ржи
            pending_texts = df_display[df["final_verdict"].isna()]["text"].tolist()
            
            if not pending_texts:
                st.success("ЁЯОЙ рж╕ржХрж▓ рж░рж┐ржкрзЛрж░рзНржЯ ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ!")
            else:
                selected_text = st.selectbox("рж░рж┐ржкрзЛрж░рзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи (рж╢рзБржзрзБржорж╛рждрзНрж░ ржкрзЗржирзНржбрж┐ржВ):", pending_texts)
                
                # ржЗржиржбрзЗржХрзНрж╕ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржирж┐рж░рж╛ржкржж ржЙржкрж╛рзЯ
                selected_index_list = df[df["text"] == selected_text].index
                
                if not selected_index_list.empty:
                    selected_index = selected_index_list[0]
                    selected_row = df.loc[selected_index]

                    st.markdown(f"**рж░рж┐ржкрзЛрж░рзНржЯ:** `{selected_row['text']}`")
                    st.markdown(f"**AI ржнрж╛рж░рзНржбрж┐ржХрзНржЯ:** `{selected_row.get('verdict', 'N/A')}` (рж╕рзНржХрзЛрж░: `{selected_row.get('score', 'N/A')}`%)")
                    st.markdown(f"**AI ржмрзНржпрж╛ржЦрзНржпрж╛:** *{selected_row.get('justification', 'N/A')}*")
                    
                    status = st.radio(
                        "ржлрзНржпрж╛ржХрзНржЯ-ржЪрзЗржХ ржлрж▓рж╛ржлрж▓:", 
                        ["рж╕рждрзНржп", "ржмрж┐ржнрзНрж░рж╛ржирзНрждрж┐ржХрж░", "ржорж┐ржерзНржпрж╛"], 
                        key=f"status_{selected_index}",
                        horizontal=True
                    )

                    if st.button("ржлрж╛ржЗржирж╛рж▓ ржЯрзНржпрж╛ржЧ ржХрж░рзБржи тЬЕ", type="primary"):
                        # ржкрзНрж░ржержорзЗ ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рзБржи
                        df.loc[selected_index, "final_verdict"] = status
                        save_data(df)
                        st.cache_data.clear()
                        logging.info(f"ржЕрзНржпрж╛ржбржорж┐ржи рж░рж┐ржкрзЛрж░рзНржЯ #{selected_index} ржХрзЗ '{status}' рж╣рж┐рж╕рзЗржмрзЗ ржЯрзНржпрж╛ржЧ ржХрж░рзЗржЫрзЗржиред")
                        
                        # ==========================================================
                        # ============== ржЖржкржирж╛рж░ ржирждрзБржи ржорзНржпрж╛ржирзБрзЯрж╛рж▓ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ рж▓ржЬрж┐ржХ (ржнрж╛рж░рзНрж╕ржи рзй.рзи) ==============
                        if status == "ржорж┐ржерзНржпрж╛":
                            # check score safety
                            try:
                                pkt_score = int(selected_row.get("score", 0))
                            except Exception:
                                pkt_score = 0

                            # decide whether to auto send or ask for manual send
                            if auto_send and pkt_score >= alert_threshold:
                                alert_msg = (
                                    f"ЁЯЪи <b>ржнрзБржпрж╝рж╛ рждржерзНржп рж╢ржирж╛ржХрзНржд! (ржпрж╛ржЪрж╛ржЗржХрзГржд)</b> ЁЯЪи\n\n"
                                    f"<b>рждржерзНржп:</b>\n<i>{selected_row['text']}</i>\n\n"
                                    f"<b>AI рж╕рзНржХрзЛрж░:</b> {pkt_score}%\n"
                                    f"<b>рж╕рж┐ржжрзНржзрж╛ржирзНржд:</b> тЭМ {status}\n\n"
                                    f"<i>#Build4Democracy #YachaiBot</i>"
                                )
                                if send_alert(alert_msg):
                                    logging.info(f"рж░рж┐ржкрзЛрж░рзНржЯ #{selected_index} ржПрж░ ржЬржирзНржп ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред")
                                    st.success("ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред")
                                else:
                                    st.error("ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛рждрзЗ ржмрзНржпрж░рзНрже тАФ рж▓ржЧ ржЪрзЗржХ ржХрж░ред")
                                # ржЕржЯрзЛ-рж╕рзЗржирзНржб рж╕ржлрж▓ (ржмрж╛ ржмрзНржпрж░рзНрже) рж╣ржУрзЯрж╛рж░ ржкрж░ ржкрзЗржЬ рж░рж┐рж▓рзЛржб ржХрж░рзБржи
                                st.rerun()
                            
                            else:
                                # manual confirmation UI (ржЕрзНржпрж╛ржбржорж┐ржиржХрзЗ ржЬрж┐ржЬрзНржЮрзЗрж╕ ржХрж░рзЗ ржкрж╛ржарж╛ржмрзЗ)
                                # *ржкрзЗржЬ рж░рж┐рж▓рзЛржб ржХрж░рж╛ рж╣ржмрзЗ ржирж╛*, ржпрж╛рждрзЗ ржирж┐ржЪрзЗрж░ ржмрж╛ржЯржиржЯрж┐ ржжрзЗржЦрж╛ ржпрж╛рзЯ
                                st.info("ржПржЗ ржЖржЗржЯрзЗржоржЯрж┐ ржорж┐ржерзНржпрж╛ рж╣рж┐рж╕рзЗржмрзЗ ржЯрзНржпрж╛ржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
                                st.write(f"AI рж╕рзНржХрзЛрж░: **{pkt_score}%** | Alert threshold: **{alert_threshold}%** | Auto-send: **{auto_send}**")
                                
                                if st.button("ЁЯУи Send Telegram alert now (manual)", key=f"manual_send_{selected_index}"):
                                    alert_msg = (
                                        f"ЁЯЪи <b>ржнрзБржпрж╝рж╛ рждржерзНржп рж╢ржирж╛ржХрзНржд! (ржпрж╛ржЪрж╛ржЗржХрзГржд)</b> ЁЯЪи\n\n"
                                        f"<b>рждржерзНржп:</b>\n<i>{selected_row['text']}</i>\n\n"
                                        f"<b>AI рж╕рзНржХрзЛрж░:</b> {pkt_score}%\n"
                                        f"<b>рж╕рж┐ржжрзНржзрж╛ржирзНржд:</b> тЭМ {status}\n\n"
               f"<b>AI рж╕рзНржХрзЛрж░:</b> {pkt_score}%\n"
                                    f"<b>рж╕рж┐ржжрзНржзрж╛ржирзНржд:</b> тЭМ {status}\n\n"
                                    f"<i>#Build4Democracy #YachaiBot</i>"
                                )
                                if send_alert(alert_msg):
                                    logging.info(f"рж░рж┐ржкрзЛрж░рзНржЯ #{selected_index} ржПрж░ ржЬржирзНржп ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред")
                                    st.success("ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред")
                                else:
                                    st.error("ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛рждрзЗ ржмрзНржпрж░рзНрже тАФ рж▓ржЧ ржЪрзЗржХ ржХрж░ред")
                                # ржЕржЯрзЛ-рж╕рзЗржирзНржб рж╕ржлрж▓ (ржмрж╛ ржмрзНржпрж░рзНрже) рж╣ржУрзЯрж╛рж░ ржкрж░ ржкрзЗржЬ рж░рж┐рж▓рзЛржб ржХрж░рзБржи
                                st.rerun()
                            
                            else:
                                # manual confirmation UI (ржЕрзНржпрж╛ржбржорж┐ржиржХрзЗ ржЬрж┐ржЬрзНржЮрзЗрж╕ ржХрж░рзЗ ржкрж╛ржарж╛ржмрзЗ)
                                # *ржкрзЗржЬ рж░рж┐рж▓рзЛржб ржХрж░рж╛ рж╣ржмрзЗ ржирж╛*, ржпрж╛рждрзЗ ржирж┐ржЪрзЗрж░ ржмрж╛ржЯржиржЯрж┐ ржжрзЗржЦрж╛ ржпрж╛рзЯ
                                st.info("ржПржЗ ржЖржЗржЯрзЗржоржЯрж┐ ржорж┐ржерзНржпрж╛ рж╣рж┐рж╕рзЗржмрзЗ ржЯрзНржпрж╛ржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
                                st.write(f"AI рж╕рзНржХрзЛрж░: **{pkt_score}%** | Alert threshold: **{alert_threshold}%** | Auto-send: **{auto_send}**")
                                
                                if st.button("ЁЯУи Send Telegram alert now (manual)", key=f"manual_send_{selected_index}"):
                                    alert_msg = (
                                        f"ЁЯЪи <b>ржнрзБржпрж╝рж╛ рждржерзНржп рж╢ржирж╛ржХрзНржд! (ржпрж╛ржЪрж╛ржЗржХрзГржд)</b> ЁЯЪи\n\n"
                                        f"<b>рждржерзНржп:</b>\n<i>{selected_row['text']}</i>\n\n"
                                        f"<b>AI рж╕рзНржХрзЛрж░:</b> {pkt_score}%\n"
                                        f"<b>рж╕рж┐ржжрзНржзрж╛ржирзНржд:</b> тЭМ {status}\n\n"
                                        f"<i>#Build4Democracy #YachaiBot</i>"
                                    )
                                    if send_alert(alert_msg):
                                        logging.info(f"рж░рж┐ржкрзЛрж░рзНржЯ #{selected_index} ржПрж░ ржЬржирзНржп ржорзНржпрж╛ржирзБрзЯрж╛рж▓ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред")
                                        st.success("ржорзНржпрж╛ржирзБрзЯрж╛рж▓ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред")
                                        st.rerun() # ржорзНржпрж╛ржирзБрзЯрж╛рж▓рж┐ ржкрж╛ржарж╛ржирзЛрж░ ржкрж░ рж░рж┐рж▓рзЛржб
                                    else:
                                        st.error("ржорзНржпрж╛ржирзБрзЯрж╛рж▓ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ ржкрж╛ржарж╛рждрзЗ ржмрзНржпрж░рзНрже тАФ рж▓ржЧ ржЪрзЗржХ ржХрж░ред")
                        
                        else:
                            # ржпржжрж┐ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ "ржорж┐ржерзНржпрж╛" ржирж╛ рж╣рзЯ (ржпрзЗржоржи: рж╕рждрзНржп ржмрж╛ ржмрж┐ржнрзНрж░рж╛ржирзНрждрж┐ржХрж░)
                            st.success(f"тЬЕ '{status}' рж╣рж┐рж╕рзЗржмрзЗ рж╕ржВрж░ржХрзНрж╖рж┐ржд!")
                            st.rerun()
                        # ==========================================================
                        
                else:
                    st.error("ржирж┐рж░рзНржмрж╛ржЪрж┐ржд ржЯрзЗржХрзНрж╕ржЯржЯрж┐ ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ рж░рж┐рж▓рзЛржб ржХрж░рзБржиред")


    elif password != "":
        st.sidebar.error("тЭМ ржнрзБрж▓ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб!")
        logging.warning(f"ржнрзБрж▓ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржжрж┐рзЯрзЗ рж▓ржЧржЗржи ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ред ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб: '{password}'")
    else:
        st.sidebar.info("ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓ ржжрзЗржЦрждрзЗ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржжрж┐ржиред")
